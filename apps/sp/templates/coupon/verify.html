{% extends "../layout.html" %}
{% block title %}券验证{% end %}
{% block menu %}
    {% module menu('coupon.verify') %}
{% end%}

{% block content %}
    <div class="ui-title fn-clear">
        <h2 class="fn-left">券验证</h2>
    </div>
    <div class="ui-form">
        {% module xsrf_form_html() %}
        <div class="ui-form-item">
            <label class="ui-label">
                <span class="ui-form-required">*</span>
                选择门店
            </label>
            <select style="font-size:16px;min-width: 240px;" id="shop">
                {% for shop in all_shops %}
                    <option value="{{ shop.id }}">{{shop.name}}</option>

                {% end %}
            </select>
        </div>
        <div class="ui-form-item">
            <label class="ui-label">
                <span class="ui-form-required">*</span>
                券号/密码
            </label>
            <ul id="coupons">
                <li>
                    <input id="coupon_1" data-id="1" class="ui-input coupon-sn" name="coupon_sn" type="text" >
                    <div class="coupon-message-box">
                        <div id="success_1" class="ui-tiptext-container ui-tiptext-container-success">
                            <p class="ui-tiptext ui-tiptext-success">
                                <i class="ui-tiptext-icon iconfont" title="成功">&#xF0156;</i>
                                <span id="success_text_1"></span>
                            </p>
                        </div>
                        <div id="error_1" class="ui-tiptext-container ui-tiptext-container-error">
                            <p class="ui-tiptext ui-tiptext-error">
                                <i class="ui-tiptext-icon iconfont" title="出错">&#xF0155;</i>
                                <span id="error_text_1"></span>
                            </p>
                        </div>
                    </div>
                </li>
                <li>
                    <input id="coupon_2" data-id="2" class="ui-input coupon-sn" name="coupon_sn" type="text" >
                    <div class="coupon-message-box">
                        <div id="success_2" class="ui-tiptext-container ui-tiptext-container-success">
                            <p class="ui-tiptext ui-tiptext-success">
                                <i class="ui-tiptext-icon iconfont" title="成功">&#xF0156;</i>
                                <span id="success_text_2"></span>
                            </p>
                        </div>
                        <div id="error_2" class="ui-tiptext-container ui-tiptext-container-error">
                            <p class="ui-tiptext ui-tiptext-error">
                                <i class="ui-tiptext-icon iconfont" title="出错">&#xF0155;</i>
                                <span id="error_text_2"></span>
                            </p>
                        </div>
                    </div>
                </li>
                <li>
                    <input id="coupon_3" data-id="3" class="ui-input coupon-sn" name="coupon_sn" type="text" >
                    <div class="coupon-message-box">
                        <div id="success_3" class="ui-tiptext-container ui-tiptext-container-success">
                            <p class="ui-tiptext ui-tiptext-success">
                                <i class="ui-tiptext-icon iconfont" title="成功">&#xF0156;</i>
                                <span id="success_text_3"></span>
                            </p>
                        </div>
                        <div id="error_3" class="ui-tiptext-container ui-tiptext-container-error">
                            <p class="ui-tiptext ui-tiptext-error">
                                <i class="ui-tiptext-icon iconfont" title="出错">&#xF0155;</i>
                                <span id="error_text_3"></span>
                            </p>
                        </div>
                    </div>
                </li>
                <li>
                    <input id="coupon_4" data-id="4" class="ui-input coupon-sn" name="coupon_sn" type="text" >
                    <div class="coupon-message-box">
                        <div id="success_4" class="ui-tiptext-container ui-tiptext-container-success">
                            <p class="ui-tiptext ui-tiptext-success">
                                <i class="ui-tiptext-icon iconfont" title="成功">&#xF0156;</i>
                                <span id="success_text_4"></span>
                            </p>
                        </div>
                        <div id="error_4" class="ui-tiptext-container ui-tiptext-container-error">
                            <p class="ui-tiptext ui-tiptext-error">
                                <i class="ui-tiptext-icon iconfont" title="出错">&#xF0155;</i>
                                <span id="error_text_4"></span>
                            </p>
                        </div>
                    </div>
                </li>
                <li>
                    <input id="coupon_5" data-id="5" class="ui-input coupon-sn" name="coupon_sn" type="text" >
                    <div class="coupon-message-box">
                        <div id="success_5" class="ui-tiptext-container ui-tiptext-container-success">
                            <p class="ui-tiptext ui-tiptext-success">
                                <i class="ui-tiptext-icon iconfont" title="成功">&#xF0156;</i>
                                <span id="success_text_5"></span>
                            </p>
                        </div>
                        <div id="error_5" class="ui-tiptext-container ui-tiptext-container-error">
                            <p class="ui-tiptext ui-tiptext-error">
                                <i class="ui-tiptext-icon iconfont" title="出错">&#xF0155;</i>
                                <span id="error_text_5"></span>
                            </p>
                        </div>
                    </div>
                </li>
            </ul>
            <div class="ui-poptip" style="width:243px; margin-top:-10px;">
                <div class="ui-poptip-shadow">
                <div class="ui-poptip-container">
                    <div class="ui-poptip-arrow ui-poptip-arrow-9">
                        <em></em>
                        <span></span>
                    </div>
                    <div class="ui-poptip-content">
                        拉手网、美团网、糯米网的电子券，<br/>请输入密码进行验证
                    </div>
                </div>
                </div>
            </div>
        </div>
        <div class="ui-form-item">
            <label class="ui-label">
                手机号
            </label>
            <input id="mobile" data-id="5" class="ui-input" name="mobile" type="text" style="width:220px;">
            <p class="ui-form-explain">请输入消费者手机号，便于维护消费者信息</p>
        </div>
        <div class="ui-form-item">
            <div id="error" class="ui-tiptext-container ui-tiptext-container-error" style="margin-bottom: 10px;">
                <p class="ui-tiptext ui-tiptext-error">
                    <i class="ui-tiptext-icon iconfont" title="出错">&#xF0155;</i>
                    <span id="error_text"></span>
                </p>
            </div>
            <button type="button" id="verify-bt" class="ui-button ui-button-lorange">验证并消费</button>
            <span class="text-button" id="reset">
                <i class="ui-tiptext-icon iconfont" title="重写">&#xf015c;</i>
                全部重新填写
            </span>
        </div>
    </div>
{% end %}

{% block styles %}
    <style type="text/css">
        .coupon-sn {
            padding: 4px 10px;
            height:26px;
            font-size:20px;
            font-weight:bold;
            width:220px;
            margin-top:-1px;
            margin-bottom:10px;
        }
        .text-button {
            color:#08c;
            cursor:pointer;
            padding: 8px 10px;
        }

        #success_1, #success_2, #success_3, #success_4, #success_5,
        #error, #error_1, #error_2, #error_3, #error_4, #error_5{
            display: none;
        }

        #coupons li {
            position: relative;
            margin-top: 5px;
        }
        .coupon-message-box {
            position: absolute;
            top: 0;
            left: 250px;
            right: 0;
        }
    </style>
{% end %}

{% block scripts %}
    <script>
    seajs.use(['$', 'autumn'], function ($, autumn) {
        var coupon_count = 5;
        // 将输入的券号，按长度为4进行分割展示，当清空内容时，消除成功和失败信息
        $('.coupon-sn').bind('input propertychange', function() {
            var ele = $(this);
            var origin = ele.val();
            var raw = origin.replace(/\s/g, '');
            if (raw.length > 0) {
                raw = raw.match(/.{4}|.+$/g).join(' ');
            }
            var id = ele.attr('data-id');
            $('#success_'+id).hide();
            $('#error_'+id).hide();
            if (origin != raw) {
                ele.val(raw);
            }
        });
        // 按上下键转换focus
        $('.coupon-sn').keydown(function(e){
            var ele = $(this);
            var id = Number(ele.attr('data-id'));
            if (e.which == 38 && id > 1) { //  上键
                $('#coupon_'+(id-1)).focus();
            }else if ((e.which == 40 || e.which == 13) && id < coupon_count) { // 下键
                $('#coupon_'+(id+1)).focus();
            }
        });
        // 清除所有填写的券号，以及成功和失败信息
        $('#reset').click(function(){
            for(var i=1; i<=coupon_count; i++) {
                $('#coupon_'+i).val('');
                $('#success_'+i).hide();
                $('#error_'+i).hide();
            }
            $('#error').hide();
            $('#mobile').val('');
        });
        //验证按钮
        $('#verify-bt').click(function(){
            var btn = $(this);
            if (btn.hasClass('ui-button-ldisable')){ return; }

            for(var i=1; i<=coupon_count; i++) {
                $('#success_'+i).hide();
                $('#error_'+i).hide();
            }

            var valid_coupons=[];
            var coupon_id={}
            var error_showed = false;
            var coupon_length=0;
            for(var i=1; i<=coupon_count; i++) {
                var ele = $('#coupon_'+i);
                var raw = ele.val().replace(/\s/g, '');
                if (raw.length == 0) { continue; }
                if (coupon_length ==0){
                    coupon_length = raw.length;
                }else if (coupon_length != raw.length) {
                    $('#error_' + i).show();
                    $('#error_text_' + i).text('券号长度应该相同');
                    error_showed = true;
                    continue;
                }
                if (/^\d+$/.test(raw)) {
                    valid_coupons.push(raw);
                    coupon_id[raw] = i;
                }else {
                    $('#error_' + i).show();
                    $('#error_text_' + i).text('券号应该是纯数字');
                    error_showed = true;
                }
            }
            if (error_showed) { return; }
            if (valid_coupons.length == 0) {
                $('#error_1').show();
                $('#error_text_1').text('请输入数字券号');
                return;
            }

            btn.removeClass('ui-button-lorange').addClass('ui-button-ldisable').text('正在验证...');
            $('#error').hide();

            $.ajax({
                type: 'POST',
                cache: false,
                data: {
                    '_xsrf': autumn.get_cookie('_xsrf'),
                    'coupons': valid_coupons.join(','),
                    'mobile': $('#mobile').val(),
                    'shop_id': $('#shop').val()
                },
                complete: function() {
                    btn.removeClass('ui-button-ldisable').addClass('ui-button-lorange').text('验证并消费');
                },
                error: function() {
                    $('#error').show();
                    $('#error_text').text('请求发生错误，请【刷新页面】后再次重试');
                },
                success: function(data) {
                    if(!data.ok) {
                        $('#error').show();
                        $('#error_text').text(data.msg);
                    }else {
                        var result = data.result;
                        for (var i = 0; i < result.length; i++){
                            var r = result[i];
                            var id = coupon_id[r.coupon_sn] || coupon_id[r.coupon_pwd];
                            if (r.ok) {
                                $('#success_'+id).show();
                                $('#success_text_'+id).text(r.msg);
                            }else {
                                $('#error_'+id).show();
                                $('#error_text_'+id).text(r.msg);
                            }
                        }
                        $('#mobile').val('');
                    }
                }
            });

        });
    });
    </script>
{% end %}